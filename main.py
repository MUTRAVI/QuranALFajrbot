import os
import random
from datetime import datetime, timedelta
import pytz
from telegram import Bot
from telegram.constants import ParseMode
from apscheduler.schedulers.background import BackgroundScheduler
from prayer_times_calculator import PrayerTimesCalculator
from flask import Flask

# 1. ุฅุนุฏุงุฏุงุช ุงูุจูุช ูุงูููุงุฉ (ุชู ูุถุน ูุนุฑู ููุงุชู ูุจุงุดุฑุฉ)
TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
bot = Bot(token=TOKEN)
CHANNEL_ID = "@quranalfajr" 

# 2. ุงููุญุชูู (ุขูุงุชุ ุฃุญุงุฏูุซุ ุฃุฏุนูุฉ)
QURAN_LIST = [
    {"v": "๏ดฟููุณูุงุฑูุนููุง ุฅูููููฐ ููุบูููุฑูุฉู ูููู ุฑููุจูููููู๏ดพ", "t": "ุชูุฌูู ุฑุจุงูู ุจุงููุจุงุฏุฑุฉ ุจุงูุฃุนูุงู ุงูุตุงูุญุฉ."},
    {"v": "๏ดฟุฅูููู ููุนู ุงููุนูุณูุฑู ููุณูุฑูุง๏ดพ", "t": "ุจุดุงุฑุฉ ุจุฃู ูู ุถูู ุณูุนูุจู ูุฑุฌ ูุฑูุจ."},
    {"v": "๏ดฟููุฆูู ุดูููุฑูุชููู ููุฃูุฒููุฏูููููููู๏ดพ", "t": "ูุนุฏ ูู ุงููู ุจุฒูุงุฏุฉ ุงููุนู ููู ูุดูุฑู."},
    {"v": "๏ดฟุฃูููุง ุจูุฐูููุฑู ุงูููููู ุชูุทูููุฆูููู ุงูููููููุจู๏ดพ", "t": "ุงูุฐูุฑ ูู ุบุฐุงุก ุงูุฑูุญ ูุฑุงุญุฉ ุงูุจุงู."},
    {"v": "๏ดฟููุฅูุฐูุง ุณูุฃููููู ุนูุจูุงุฏูู ุนููููู ููุฅููููู ููุฑููุจู๏ดพ", "t": "ูุฑุจ ุงููู ูู ุนุจุงุฏู ุงููุฌูุจูู ูุฏุนุงุฆู."}
]
HADITH_LIST = [
    "ูุงู ๏ทบ: (ุฎูููุฑููููู ูููู ุชูุนูููููู ุงููููุฑูุขูู ููุนูููููููู).",
    "ูุงู ๏ทบ: (ูููู ุตููููู ุนูููููู ุตูููุงุฉู ุตููููู ุงููู ุนููููููู ุจูููุง ุนูุดูุฑูุง).",
    "ูุงู ๏ทบ: (ููููููุชูุงูู ุฎููููููุชูุงูู ุนูููู ุงููููุณูุงููุ ุซููููููุชูุงูู ููู ุงูููููุฒูุงูู: ุณูุจูุญูุงูู ุงูููููู ููุจูุญูููุฏููู).",
    "ูุงู ๏ทบ: (ุฅููููููุง ุงูุฃูุนูููุงูู ุจูุงูููููููุงุชู)."
]
DUA_LIST = [
    "ุงูููู ุฅูู ุฃุณุฃูู ุงููุฏู ูุงูุชูู ูุงูุนูุงู ูุงูุบูู.",
    "ูุง ุญู ูุง ูููู ุจุฑุญูุชู ุฃุณุชุบูุซุ ุฃุตูุญ ูู ุดุฃูู ููู.",
    "ุงูููู ุฑุจูุง ุขุชูุง ูู ุงูุฏููุง ุญุณูุฉ ููู ุงูุขุฎุฑุฉ ุญุณูุฉ ูููุง ุนุฐุงุจ ุงููุงุฑ.",
    "ุงูููู ุฅูู ุนูู ูุฑูู ุชุญุจ ุงูุนูู ูุงุนูู ุนูู."
]

# 3. ูุธููุฉ ุงููุดุฑ ุงูุนุดูุงุฆู ุงููุชุฌุฏุฏ
def send_benefit_randomly():
    # ุงุฎุชูุงุฑ ููุน ุงููุญุชูู
    choice = random.choice(['q', 'h', 'd'])
    if choice == 'q':
        item = random.choice(QURAN_LIST)
        msg = f"๐ *ูู ุขูุงุช ุงูุฐูุฑ ุงูุญููู:*\n\n{item['v']}\n\n๐ก *ุงูุชูุณูุฑ:* {item['t']}"
    elif choice == 'h':
        msg = f"โจ *ุญุฏูุซ ูุจูู ุดุฑูู:*\n\n{random.choice(HADITH_LIST)}"
    else:
        msg = f"๐คฒ *ุฏุนุงุก ูุชุถุฑุน:*\n\n{random.choice(DUA_LIST)}"
    
    try:
        bot.send_message(chat_id=CHANNEL_ID, text=msg, parse_mode=ParseMode.MARKDOWN)
    except: pass

    # ุจุฑูุฌุฉ ุงูููุดูุฑ ุงููุงุฏู ุจููุช ุนุดูุงุฆู (ุจูู 30 ู 180 ุฏูููุฉ)
    next_wait = random.randint(30, 180)
    scheduler.add_job(send_benefit_randomly, 'date', 
                      run_date=datetime.now(pytz.timezone('Asia/Riyadh')) + timedelta(minutes=next_wait))

# 4. ุงููุฌุฏูู ุงูุฒููู ุงูุฑุฆูุณู
def setup_schedule():
    try:
        # ุฅุฑุณุงู ุฃูู ููุดูุฑ ุจุนุฏ 5 ุฏูุงุฆู ูู ุชุดุบูู ุงูุจูุช
        scheduler.add_job(send_benefit_randomly, 'date', 
                          run_date=datetime.now(pytz.timezone('Asia/Riyadh')) + timedelta(minutes=5))
        
        # ุชุญุฏูุซ ุงููุฌุฏูู ููููุงู ุนูุฏ ููุชุตู ุงูููู
        scheduler.add_job(setup_schedule, 'cron', hour=0, minute=1)
    except: pass

scheduler = BackgroundScheduler(timezone="Asia/Riyadh")
setup_schedule()
scheduler.start()

# 5. ูุธุงู ุงูุจูุงุก ุญูุงู (Web Server)
app = Flask(__name__)
@app.route('/')
def home(): return "Bot is Online and Active"

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=8080)
